<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy ERP System</title>
    <style>
        /* Basic Reset and Styling */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding-top: 20px;
            flex-shrink: 0;
            overflow-y: auto;
            display: none; /* Hidden by default, shown after login */
            transition: width 0.3s;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .sidebar a {
            display: block;
            padding: 12px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: background 0.3s;
            cursor: pointer;
        }

        .sidebar a:hover {
            background-color: #34495e;
        }

        /* Main Content Styling */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #ecf0f1;
            display: none; /* Hidden by default, shown after login */
            position: relative;
        }

        .module {
            display: none;
        }

        .module.active {
            display: block;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table, th, td {
            border: 1px solid #bdc3c7;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        /* Forms */
        form {
            margin-top: 15px;
            background-color: #fff;
            padding: 15px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
        }

        form input, form select, form button, form textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        form button {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        form button:hover {
            background-color: #34495e;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .sidebar a {float: left;}
            .main-content {margin-left: 0;}
        }

        @media (max-width: 600px) {
            .sidebar a {
                text-align: center;
                float: none;
            }
        }

        /* Notification Styling */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2ecc71;
            color: #fff;
            padding: 15px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .notification.error {
            background-color: #e74c3c;
        }
        
        /* Loading Spinner */
        .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 1500;
        }

        .spinner div {
            width: 18px;
            height: 18px;
            margin: 2px;
            background: #2c3e50;
            border-radius: 100%;
            display: inline-block;
            animation: bouncedelay 1.4s infinite ease-in-out both;
        }

        .spinner .bounce1 {
            animation-delay: -0.32s;
        }

        .spinner .bounce2 {
            animation-delay: -0.16s;
        }

        @keyframes bouncedelay {
            0%, 80%, 100% { transform: scale(0) }
            40% { transform: scale(1.0) }
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            flex: 1;
            background-color: #ecf0f1;
        }

        .login-screen h1 {
            margin-bottom: 20px;
        }

        .login-button {
            padding: 10px 20px;
            background-color: #4285F4;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            transition: background 0.3s;
        }

        .login-button img {
            height: 20px;
            margin-right: 10px;
        }

        .login-button:hover {
            background-color: #357ae8;
        }

        /* Excel-like Table Styling for POS */
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .excel-table th, .excel-table td {
            border: 1px solid #bdc3c7;
            padding: 8px;
            text-align: left;
        }

        .excel-table th {
            background-color: #34495e;
            color: #ecf0f1;
        }

        .suggestions {
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background-color: #fff;
            width: calc(100% - 40px);
            z-index: 100;
        }

        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f1f1f1;
        }

        /* Popup Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 50%; 
            border-radius: 5px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

    </style>
</head>
<body>
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self'; 
    script-src 'self' https://apis.google.com https://www.gstatic.com; 
    frame-src 'self' https://www.gstatic.com https://apis.google.com;
    img-src 'self' https://developers.google.com https://www.gstatic.com; 
    style-src 'self' 'unsafe-inline';
">

    <!-- Loading Spinner -->
    <div class="spinner" id="loadingSpinner">
        <div class="bounce1"></div>
        <div class="bounce2"></div>
        <div class="bounce3"></div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <h1>Welcome to Pharmacy ERP</h1>
        <button class="login-button" id="googleSignInButton">
            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google Logo">
            Sign in with Google
        </button>
    </div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <h2>Pharmacy ERP</h2>
        <a onclick="showModule('pos')">Sales and Billing (POS)</a>
        <a onclick="showModule('inventory')">Inventory Management</a>
        <a onclick="showModule('crm')">Customer Management (CRM)</a>
        <a onclick="showModule('purchase')">Purchase & Vendor Management</a>
        <a onclick="showModule('accounting')">Accounting & Finance</a>
        <a onclick="showModule('reporting')">Reporting & Analytics</a>
        <a onclick="showModule('compliance')">Regulatory Compliance</a>
        <a onclick="showModule('employee')">Employee Management</a>
        <a style="background-color:#c0392b; margin-top:20px;" onclick="signOut()">Sign Out</a>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">

        <!-- Notification -->
        <div id="notification" class="notification"></div>

        <!-- Sales and Billing Module (POS) -->
        <div id="pos" class="module active">
            <h2>Sales and Billing (POS)</h2>
            <button onclick="toggleVisibility('posTable')">New Sale</button>
            <div id="posTable" style="display:none; position: relative;">
                <!-- Excel-like Table for POS -->
                <table class="excel-table" id="posExcelTable">
                    <thead>
                        <tr>
                            <th>Medicine Name</th>
                            <th>Strips</th>
                            <th>Tablets</th>
                            <th>Quantity</th>
                            <th>Total Price ($)</th>
                            <th>Tax ($)</th>
                            <th>Payment Method</th>
                            <th>Prescription ID</th>
                            <th>Discount Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="position: relative;">
                                <input type="text" class="medicine-name" placeholder="Enter Medicine Name" onkeyup="suggestMedicines(this)">
                                <div class="suggestions" id="suggestions"></div>
                            </td>
                            <td><input type="number" class="strip-qty" min="0" value="0" onchange="updateQuantity(this)"></td>
                            <td><input type="number" class="tablet-qty" min="0" value="0" onchange="updateQuantity(this)"></td>
                            <td><span class="total-qty">0</span></td>
                            <td><span class="total-price">0.00</span></td>
                            <td><span class="tax">0.00</span></td>
                            <td>
                                <select class="payment-method" onchange="updateTaxAndPrice(this)">
                                    <option value="">Select Payment Method</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="UPI">UPI</option>
                                    <option value="Digital Wallet">Digital Wallet</option>
                                </select>
                            </td>
                            <td><input type="text" class="prescription-id" placeholder="Prescription ID (if any)"></td>
                            <td><input type="text" class="discount-details" placeholder="Discount Details"></td>
                            <td><button onclick="processSale(this)">Process</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Sale ID</th>
                        <th>Medicine Name</th>
                        <th>Strips</th>
                        <th>Tablets</th>
                        <th>Total Quantity</th>
                        <th>Total Price ($)</th>
                        <th>Tax ($)</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="posTableBody">
                    <!-- POS sales records will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Inventory Management Module -->
        <div id="inventory" class="module">
            <h2>Inventory Management</h2>
            <button onclick="toggleVisibility('inventoryForm')">Add New Item</button>
            <div id="inventoryForm" style="display:none;">
                <form id="addInventoryForm">
                    <input type="text" id="medicineName" placeholder="Medicine Name" required>
                    <input type="number" id="quantity" placeholder="Quantity" min="1" required>
                    <input type="number" id="tabletsPerStrip" placeholder="Tablets per Strip" min="1" required>
                    <input type="text" id="batchNumber" placeholder="Batch Number" required>
                    <input type="date" id="expiryDate" required>
                    <select id="therapeuticClass" required>
                        <option value="">Select Therapeutic Class</option>
                        <option value="Analgesics">Analgesics</option>
                        <option value="Antibiotics">Antibiotics</option>
                        <option value="Cardiovascular">Cardiovascular</option>
                        <!-- Add more classes as needed -->
                    </select>
                    <button type="submit">Add Inventory Item</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Medicine Name</th>
                        <th>Quantity</th>
                        <th>Tablets per Strip</th>
                        <th>Batch Number</th>
                        <th>Expiry Date</th>
                        <th>Therapeutic Class</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <!-- Inventory items will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Customer Management (CRM) Module -->
        <div id="crm" class="module">
            <h2>Customer Management (CRM)</h2>
            <button onclick="toggleVisibility('crmForm')">Add Customer</button>
            <div id="crmForm" style="display:none;">
                <form id="addCustomerForm">
                    <input type="text" id="customerName" placeholder="Customer Name" required>
                    <input type="email" id="customerEmail" placeholder="Email" required>
                    <input type="text" id="customerPhone" placeholder="Phone Number" required>
                    <input type="text" id="customerPrescription" placeholder="Prescription History">
                    <button type="submit">Add Customer</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Customer ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Prescription History</th>
                        <th>Loyalty Points</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="crmTableBody">
                    <!-- Customer records will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Purchase & Vendor Management Module -->
        <div id="purchase" class="module">
            <h2>Purchase & Vendor Management</h2>
            <button onclick="toggleVisibility('purchaseForm')">New Purchase Order</button>
            <div id="purchaseForm" style="display:none;">
                <form id="addPurchaseForm">
                    <input type="text" id="vendorName" placeholder="Vendor Name" required>
                    <input type="text" id="purchaseMedicineName" placeholder="Medicine Name" required>
                    <input type="number" id="purchaseQuantity" placeholder="Quantity" min="1" required>
                    <select id="purchaseStatus" required>
                        <option value="">Select Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <button type="submit">Create Purchase Order</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>PO ID</th>
                        <th>Vendor</th>
                        <th>Medicine</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="purchaseTableBody">
                    <!-- Purchase orders will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Accounting & Finance Module -->
        <div id="accounting" class="module">
            <h2>Accounting & Finance</h2>
            <p>Integration with POS for daily sales tracking, automated GST/VAT filing, financial reports, and more.</p>
            <!-- Additional forms and tables can be added here -->

            <!-- Google Drive Backup and Restore Buttons -->
            <button onclick="saveDataToDrive()">Backup Data to Google Drive</button>
            <button onclick="loadDataFromDrive()">Restore Data from Google Drive</button>
        </div>

        <!-- Reporting & Analytics Module -->
        <div id="reporting" class="module">
            <h2>Reporting & Analytics</h2>
            <p>Generate and view various reports on sales, inventory, profitability, and more.</p>
            <!-- Integration with Chart.js or similar libraries can be added for visual analytics -->
        </div>

        <!-- Regulatory Compliance Module -->
        <div id="compliance" class="module">
            <h2>Regulatory Compliance</h2>
            <p>Maintain records for controlled substances, integrate with e-prescription systems, and ensure legal compliance.</p>
            <!-- Additional forms and tables can be added here -->
        </div>

        <!-- Employee Management Module -->
        <div id="employee" class="module">
            <h2>Employee Management</h2>
            <p>Manage employee roles, track sales performance, handle shift schedules, and monitor attendance.</p>
            <!-- Additional forms and tables can be added here -->
        </div>

        <!-- Popup Modal for Adding New Product -->
        <div id="addProductModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Add New Product</h2>
                <form id="addNewProductForm">
                    <input type="text" id="newMedicineName" placeholder="Medicine Name" required>
                    <input type="number" id="newQuantity" placeholder="Quantity" min="1" required>
                    <input type="number" id="newTabletsPerStrip" placeholder="Tablets per Strip" min="1" required>
                    <input type="text" id="newBatchNumber" placeholder="Batch Number" required>
                    <input type="date" id="newExpiryDate" required>
                    <select id="newTherapeuticClass" required>
                        <option value="">Select Therapeutic Class</option>
                        <option value="Analgesics">Analgesics</option>
                        <option value="Antibiotics">Antibiotics</option>
                        <option value="Cardiovascular">Cardiovascular</option>
                        <!-- Add more classes as needed -->
                    </select>
                    <button type="submit">Add Product</button>
                </form>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- Your JavaScript Code -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBJLp1AAqdEVxs-eZBUPPgNfK-SjOuLpz0",
  authDomain: "sms-verification-ea68f.firebaseapp.com",
  projectId: "sms-verification-ea68f",
  storageBucket: "sms-verification-ea68f.appspot.com",
  messagingSenderId: "977038537918",
  appId: "1:977038537918:web:46761c2376a03978851aef",
  measurementId: "G-ZE4HSES1R6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Google API Client ID and API Key
        const CLIENT_ID = '977038537918-7k4g6gql6148mjb3saq0m04l6gk3hmas.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBJLp1AAqdEVxs-eZBUPPgNfK-SjOuLpz0';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // Notification Function
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Loading Spinner Control
        function showSpinner() {
            document.getElementById('loadingSpinner').style.display = 'block';
        }

        function hideSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        // Initialize Google API Client
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                scope: SCOPES
            }).then(() => {
                console.log("Google API Client Initialized.");
                return gapi.client.load('drive', 'v3'); // Load Drive API
            }).then(() => {
                console.log("Google Drive API loaded.");
            }).catch((error) => {
                console.error("Error initializing Google API client:", error);
                showNotification("Error initializing Google API client.", true);
            });
        }

        gapi.load('client:auth2', initClient);

        // Sign In with Google
        const googleSignInButton = document.getElementById('googleSignInButton');
        googleSignInButton.addEventListener('click', () => {
            showSpinner();
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/drive.file');
            firebase.auth().signInWithPopup(provider)
                .then((result) => {
                    hideSpinner();
                    // The signed-in user info.
                    const user = result.user;
                    // Get Google access token
                    const credential = result.credential;
                    const token = credential.accessToken;
                    // Initialize Google API Client with token
                    gapi.auth.setToken({
                        access_token: token
                    });
                    // Show ERP interface
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('sidebar').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'block';
                    showNotification("Successfully signed in!");

                    // Load existing data from Google Drive
                    loadDataFromDrive();
                }).catch((error) => {
                    hideSpinner();
                    console.error("Error during sign in:", error);
                    showNotification("Error during sign in.", true);
                });
        });

        // Sign Out Function
        function signOut() {
            showSpinner();
            firebase.auth().signOut().then(() => {
                // Sign-out successful.
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('sidebar').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';
                showNotification("Signed out successfully.");
                hideSpinner();
            }).catch((error) => {
                hideSpinner();
                console.error("Error during sign out:", error);
                showNotification("Error during sign out.", true);
            });
        }

        // Module Navigation
        function showModule(moduleId) {
            const modules = document.querySelectorAll('.module');
            modules.forEach(module => {
                if(module.id === moduleId){
                    module.classList.add('active');
                } else {
                    module.classList.remove('active');
                }
            });
        }

        // Toggle Form/Table Visibility
        function toggleVisibility(elementId) {
            const element = document.getElementById(elementId);
            if (element.style.display === "none" || element.style.display === "") {
                element.style.display = "block";
            } else {
                element.style.display = "none";
            }
        }

        /* ------------------------- Google Drive Integration ------------------------- */

        // Utility function to create a file in Google Drive
        function createFile(fileName, content) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";

            const metadata = {
                'name': fileName,
                'mimeType': 'application/json'
            };

            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(content) +
                close_delim;

            return gapi.client.request({
                'path': '/upload/drive/v3/files',
                'method': 'POST',
                'params': {'uploadType': 'multipart'},
                'headers': {
                  'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                },
                'body': multipartRequestBody
            });
        }

        // Utility function to search for a file by name
        function searchFile(fileName) {
            return gapi.client.drive.files.list({
                'q': `name='${fileName}' and mimeType='application/json'`,
                'fields': 'files(id, name)'
            });
        }

        // Utility function to update a file in Google Drive
        function updateFile(fileId, content) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";

            const metadata = {
                'name': 'pharmacy_erp_data.json',
                'mimeType': 'application/json'
            };

            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(content) +
                close_delim;

            return gapi.client.request({
                'path': `/upload/drive/v3/files/${fileId}`,
                'method': 'PATCH',
                'params': {'uploadType': 'multipart'},
                'headers': {
                  'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                },
                'body': multipartRequestBody
            });
        }

        // Utility function to get file content
        function getFileContent(fileId) {
            return gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
        }

        // Save Data to Google Drive
        async function saveDataToDrive() {
            showSpinner();
            const data = {
                sales: window.salesData || {},
                inventory: window.inventoryData || {},
                customers: window.customersData || {},
                purchase: window.purchaseData || {}
            };

            try {
                const searchResponse = await searchFile('pharmacy_erp_data.json');
                if (searchResponse.result.files.length > 0) {
                    // File exists, update it
                    const fileId = searchResponse.result.files[0].id;
                    await updateFile(fileId, data);
                    showNotification("Data backed up to Google Drive successfully!");
                } else {
                    // File does not exist, create it
                    await createFile('pharmacy_erp_data.json', data);
                    showNotification("Data backed up to Google Drive successfully!");
                }
            } catch (error) {
                console.error("Error saving data to Drive:", error);
                showNotification("Error saving data to Drive.", true);
            }
            hideSpinner();
        }

        // Load Data from Google Drive
        async function loadDataFromDrive() {
            showSpinner();
            try {
                const searchResponse = await searchFile('pharmacy_erp_data.json');
                if (searchResponse.result.files.length > 0) {
                    const fileId = searchResponse.result.files[0].id;
                    const contentResponse = await getFileContent(fileId);
                    const data = JSON.parse(contentResponse.body);

                    // Load Inventory Data
                    window.inventoryData = data.inventory || {};
                    populateInventoryTable();

                    // Load Sales Data
                    window.salesData = data.sales || {};
                    populateSalesTable();

                    // Load Customer Data
                    window.customersData = data.customers || {};
                    populateCustomerTable();

                    // Load Purchase Data
                    window.purchaseData = data.purchase || {};
                    populatePurchaseTable();

                    showNotification("Data loaded from Google Drive successfully!");
                } else {
                    showNotification("No backup file found on Drive.", true);
                }
            } catch (error) {
                console.error("Error loading data from Drive:", error);
                showNotification("Error loading data from Drive.", true);
            }
            hideSpinner();
        }

        /* ------------------------- Inventory Management ---------------------------- */

        // Inventory Data Structure
        window.inventoryData = {};

        // Add Inventory Item
        const addInventoryForm = document.getElementById('addInventoryForm');
        addInventoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const medicineName = document.getElementById('medicineName').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const tabletsPerStrip = parseInt(document.getElementById('tabletsPerStrip').value);
            const batchNumber = document.getElementById('batchNumber').value.trim();
            const expiryDate = document.getElementById('expiryDate').value;
            const therapeuticClass = document.getElementById('therapeuticClass').value;

            const id = 'inv_' + new Date().getTime();

            window.inventoryData[id] = {
                medicineName,
                quantity,
                tabletsPerStrip,
                batchNumber,
                expiryDate,
                therapeuticClass
            };

            addInventoryForm.reset();
            document.getElementById('inventoryForm').style.display = 'none';
            showNotification("Inventory item added successfully!");
            populateInventoryTable();
            saveDataToDrive();
        });

        // Populate Inventory Table
        function populateInventoryTable() {
            const inventoryTableBody = document.getElementById('inventoryTableBody');
            inventoryTableBody.innerHTML = '';
            for (const id in window.inventoryData) {
                const data = window.inventoryData[id];
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${data.medicineName}</td>
                    <td>${data.quantity}</td>
                    <td>${data.tabletsPerStrip}</td>
                    <td>${data.batchNumber}</td>
                    <td>${data.expiryDate}</td>
                    <td>${data.therapeuticClass}</td>
                    <td>
                        <button onclick="editInventory('${id}')">Edit</button>
                        <button onclick="deleteInventory('${id}')">Delete</button>
                    </td>
                `;
                inventoryTableBody.appendChild(row);
            }
        }

        // Edit Inventory Item
        function editInventory(id) {
            const data = window.inventoryData[id];
            const newMedicineName = prompt("Enter new Medicine Name:", data.medicineName);
            if (newMedicineName === null) return; // Cancelled
            const newQuantity = prompt("Enter new Quantity:", data.quantity);
            if (newQuantity === null || isNaN(newQuantity) || newQuantity < 0) {
                showNotification("Invalid quantity entered.", true);
                return;
            }
            const newTabletsPerStrip = prompt("Enter new Tablets per Strip:", data.tabletsPerStrip);
            if (newTabletsPerStrip === null || isNaN(newTabletsPerStrip) || newTabletsPerStrip < 1) {
                showNotification("Invalid tablets per strip entered.", true);
                return;
            }
            const newBatchNumber = prompt("Enter new Batch Number:", data.batchNumber);
            if (newBatchNumber === null) return;
            const newExpiryDate = prompt("Enter new Expiry Date (YYYY-MM-DD):", data.expiryDate);
            if (newExpiryDate === null) return;
            const newTherapeuticClass = prompt("Enter new Therapeutic Class:", data.therapeuticClass);
            if (newTherapeuticClass === null) return;

            window.inventoryData[id] = {
                medicineName: newMedicineName.trim(),
                quantity: parseInt(newQuantity),
                tabletsPerStrip: parseInt(newTabletsPerStrip),
                batchNumber: newBatchNumber.trim(),
                expiryDate: newExpiryDate,
                therapeuticClass: newTherapeuticClass.trim()
            };

            showNotification("Inventory updated successfully!");
            populateInventoryTable();
            saveDataToDrive();
        }

        // Delete Inventory Item
        function deleteInventory(id) {
            if(confirm("Are you sure you want to delete this inventory item?")) {
                delete window.inventoryData[id];
                showNotification("Inventory item deleted successfully!");
                populateInventoryTable();
                saveDataToDrive();
            }
        }

        /* ------------------------- Sales and Billing (POS) ------------------------- */

        // Sales Data Structure
        window.salesData = {};

        // Populate Sales Table
        function populateSalesTable() {
            const posTableBody = document.getElementById('posTableBody');
            posTableBody.innerHTML = '';
            for (const id in window.salesData) {
                const data = window.salesData[id];
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${id}</td>
                    <td>${data.medicineName}</td>
                    <td>${data.strips}</td>
                    <td>${data.tablets}</td>
                    <td>${data.totalQuantity}</td>
                    <td>${data.totalPrice.toFixed(2)}</td>
                    <td>${data.tax.toFixed(2)}</td>
                    <td>${data.saleDate}</td>
                    <td>
                        <button onclick="viewSale('${id}')">View</button>
                        <!-- Implement Edit/Delete if needed -->
                    </td>
                `;
                posTableBody.appendChild(row);
            }
        }

        // Process Sale from POS Table
        function processSale(button) {
            const row = button.parentElement.parentElement;
            const medicineName = row.querySelector('.medicine-name').value.trim();
            const strips = parseInt(row.querySelector('.strip-qty').value) || 0;
            const tablets = parseInt(row.querySelector('.tablet-qty').value) || 0;
            const totalQuantity = (strips * (getTabletsPerStrip(medicineName)) ) + tablets;
            const paymentMethod = row.querySelector('.payment-method').value;
            const prescriptionId = row.querySelector('.prescription-id').value.trim() || "N/A";
            const discountDetails = row.querySelector('.discount-details').value.trim() || "0";

            if (medicineName === "" || (strips === 0 && tablets === 0) || paymentMethod === "") {
                showNotification("Please fill in all required fields.", true);
                return;
            }

            // Calculate Price and Tax
            const unitPrice = getUnitPrice(medicineName); // Implement getUnitPrice
            const totalPrice = totalQuantity * unitPrice;
            const tax = totalPrice * 0.18; // Assuming 18% tax

            const saleDate = new Date().toLocaleDateString();

            const id = 'sale_' + new Date().getTime();

            window.salesData[id] = {
                medicineName,
                strips,
                tablets,
                totalQuantity,
                totalPrice,
                tax,
                paymentMethod,
                prescriptionId,
                discountDetails,
                saleDate
            };

            // Update Inventory
            if(window.inventoryData){
                for (const invId in window.inventoryData) {
                    if(window.inventoryData[invId].medicineName.toLowerCase() === medicineName.toLowerCase()){
                        window.inventoryData[invId].quantity -= totalQuantity;
                        break;
                    }
                }
            }

            // Reset POS Table Row
            row.querySelector('.medicine-name').value = "";
            row.querySelector('.strip-qty').value = 0;
            row.querySelector('.tablet-qty').value = 0;
            row.querySelector('.total-qty').textContent = "0";
            row.querySelector('.total-price').textContent = "0.00";
            row.querySelector('.tax').textContent = "0.00";
            row.querySelector('.payment-method').value = "";
            row.querySelector('.prescription-id').value = "";
            row.querySelector('.discount-details').value = "";

            showNotification("Sale processed successfully!");
            populateSalesTable();
            populateInventoryTable();
            saveDataToDrive();
        }

        // Get Tablets Per Strip from Inventory
        function getTabletsPerStrip(medicineName) {
            for (const id in window.inventoryData) {
                if(window.inventoryData[id].medicineName.toLowerCase() === medicineName.toLowerCase()){
                    return window.inventoryData[id].tabletsPerStrip;
                }
            }
            return 10; // Default value if not found
        }

        // Placeholder function for unit price (implement actual pricing logic)
        function getUnitPrice(medicineName) {
            // For demonstration, assume $5 per tablet
            return 5;
        }

        // View Sale Details
        function viewSale(id) {
            const data = window.salesData[id];
            if(data){
                alert(`Sale Details:
    Sale ID: ${id}
    Medicine Name: ${data.medicineName}
    Strips: ${data.strips}
    Tablets: ${data.tablets}
    Total Quantity: ${data.totalQuantity}
    Total Price: $${data.totalPrice.toFixed(2)}
    Tax: $${data.tax.toFixed(2)}
    Payment Method: ${data.paymentMethod}
    Prescription ID: ${data.prescriptionId}
    Discount Details: ${data.discountDetails}
    Date: ${data.saleDate}`);
            } else {
                alert("No such sale record!");
            }
        }

        // Update Quantity and Recalculate Price and Tax
        function updateQuantity(element) {
            const row = element.closest('tr');
            const stripQty = parseInt(row.querySelector('.strip-qty').value) || 0;
            const tabletQty = parseInt(row.querySelector('.tablet-qty').value) || 0;
            const medicineName = row.querySelector('.medicine-name').value.trim();
            
            // Fetch tablets per strip from inventory
            const tabletsPerStrip = getTabletsPerStrip(medicineName);
            const totalQty = (stripQty * tabletsPerStrip) + tabletQty;
            row.querySelector('.total-qty').textContent = totalQty;
            
            // Calculate total price and tax
            const unitPrice = getUnitPrice(medicineName);
            const totalPrice = totalQty * unitPrice;
            const tax = totalPrice * 0.18; // Assuming 18% tax
            
            row.querySelector('.total-price').textContent = totalPrice.toFixed(2);
            row.querySelector('.tax').textContent = tax.toFixed(2);
        }

        function updateTaxAndPrice(element) {
            const row = element.closest('tr');
            const totalPrice = parseFloat(row.querySelector('.total-price').textContent) || 0;
            const tax = totalPrice * 0.18; // Assuming 18% tax
            row.querySelector('.tax').textContent = tax.toFixed(2);
        }

        /* ------------------------- Customer Management (CRM) ---------------------- */

        // Customers Data Structure
        window.customersData = {};

        // Add Customer
        const addCustomerForm = document.getElementById('addCustomerForm');
        addCustomerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const customerName = document.getElementById('customerName').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const prescriptionHistory = document.getElementById('customerPrescription').value.trim() || "N/A";

            const id = 'cust_' + new Date().getTime();

            window.customersData[id] = {
                customerName,
                customerEmail,
                customerPhone,
                prescriptionHistory,
                loyaltyPoints: 0,
                createdAt: new Date().toISOString()
            };

            addCustomerForm.reset();
            document.getElementById('crmForm').style.display = 'none';
            showNotification("Customer added successfully!");
            populateCustomerTable();
            saveDataToDrive();
        });

        // Populate Customer Table
        function populateCustomerTable() {
            const crmTableBody = document.getElementById('crmTableBody');
            crmTableBody.innerHTML = '';
            for (const id in window.customersData) {
                const data = window.customersData[id];
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${id}</td>
                    <td>${data.customerName}</td>
                    <td>${data.customerEmail}</td>
                    <td>${data.customerPhone}</td>
                    <td>${data.prescriptionHistory}</td>
                    <td>${data.loyaltyPoints}</td>
                    <td>
                        <button onclick="viewCustomer('${id}')">View</button>
                        <button onclick="updateLoyalty('${id}')">Update Loyalty</button>
                        <button onclick="deleteCustomer('${id}')">Delete</button>
                    </td>
                `;
                crmTableBody.appendChild(row);
            }
        }

        // View Customer Details
        function viewCustomer(id) {
            const data = window.customersData[id];
            if(data){
                alert(`Customer Details:
ID: ${id}
Name: ${data.customerName}
Email: ${data.customerEmail}
Phone: ${data.customerPhone}
Prescription History: ${data.prescriptionHistory}
Loyalty Points: ${data.loyaltyPoints}
Member Since: ${new Date(data.createdAt).toLocaleDateString()}`);
            } else {
                alert("No such customer record!");
            }
        }

        // Update Loyalty Points
        function updateLoyalty(id) {
            const additionalPoints = prompt("Enter additional loyalty points:", 0);
            if (additionalPoints === null || isNaN(additionalPoints) || additionalPoints < 0) {
                showNotification("Invalid points entered.", true);
                return;
            }
            window.customersData[id].loyaltyPoints += parseInt(additionalPoints);
            showNotification("Loyalty points updated successfully!");
            populateCustomerTable();
            saveDataToDrive();
        }

        // Delete Customer
        function deleteCustomer(id) {
            if(confirm("Are you sure you want to delete this customer?")) {
                delete window.customersData[id];
                showNotification("Customer deleted successfully!");
                populateCustomerTable();
                saveDataToDrive();
            }
        }

        /* ---------------------- Purchase & Vendor Management ----------------------- */

        // Purchase Data Structure
        window.purchaseData = {};

        // Add Purchase Order
        const addPurchaseForm = document.getElementById('addPurchaseForm');
        addPurchaseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const vendorName = document.getElementById('vendorName').value.trim();
            const purchaseMedicineName = document.getElementById('purchaseMedicineName').value.trim();
            const purchaseQuantity = parseInt(document.getElementById('purchaseQuantity').value);
            const purchaseStatus = document.getElementById('purchaseStatus').value;
            const purchaseDate = new Date().toLocaleDateString();

            const id = 'po_' + new Date().getTime();

            window.purchaseData[id] = {
                vendorName,
                purchaseMedicineName,
                purchaseQuantity,
                purchaseStatus,
                purchaseDate
            };

            addPurchaseForm.reset();
            document.getElementById('purchaseForm').style.display = 'none';
            showNotification("Purchase order created successfully!");
            populatePurchaseTable();
            saveDataToDrive();
        });

        // Populate Purchase Table
        function populatePurchaseTable() {
            const purchaseTableBody = document.getElementById('purchaseTableBody');
            purchaseTableBody.innerHTML = '';
            for (const id in window.purchaseData) {
                const data = window.purchaseData[id];
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${id}</td>
                    <td>${data.vendorName}</td>
                    <td>${data.purchaseMedicineName}</td>
                    <td>${data.purchaseQuantity}</td>
                    <td>${data.purchaseStatus}</td>
                    <td>${data.purchaseDate}</td>
                    <td>
                        <button onclick="updatePurchaseStatus('${id}')">Update</button>
                        <button onclick="deletePurchase('${id}')">Delete</button>
                    </td>
                `;
                purchaseTableBody.appendChild(row);
            }
        }

        // Update Purchase Status
        function updatePurchaseStatus(id) {
            const currentStatus = window.purchaseData[id].purchaseStatus;
            const newStatus = prompt("Enter new status (Pending, Completed, Cancelled):", currentStatus);
            if (newStatus === null || !["Pending", "Completed", "Cancelled"].includes(newStatus)) {
                showNotification("Invalid status entered.", true);
                return;
            }
            window.purchaseData[id].purchaseStatus = newStatus;
            showNotification("Purchase status updated successfully!");
            populatePurchaseTable();
            saveDataToDrive();

            // If Completed, update inventory
            if(newStatus === "Completed"){
                const medicineName = window.purchaseData[id].purchaseMedicineName;
                const quantity = window.purchaseData[id].purchaseQuantity;
                updateInventoryAfterPurchase(medicineName, quantity);
            }
        }

        // Update Inventory After Purchase
        function updateInventoryAfterPurchase(medicineName, quantityPurchased) {
            for (const id in window.inventoryData) {
                if(window.inventoryData[id].medicineName.toLowerCase() === medicineName.toLowerCase()){
                    window.inventoryData[id].quantity += quantityPurchased;
                    showNotification(`Inventory updated for ${medicineName}.`);
                    populateInventoryTable();
                    saveDataToDrive();
                    break;
                }
            }
        }

        // Delete Purchase Order
        function deletePurchase(id) {
            if(confirm("Are you sure you want to delete this purchase order?")) {
                delete window.purchaseData[id];
                showNotification("Purchase order deleted successfully!");
                populatePurchaseTable();
                saveDataToDrive();
            }
        }

        /* ------------------------- Medicine Suggestions --------------------------- */

        function suggestMedicines(inputElem) {
            const query = inputElem.value.trim().toLowerCase();
            const suggestionsBox = inputElem.nextElementSibling;
            suggestionsBox.innerHTML = '';

            if(query.length === 0){
                suggestionsBox.style.display = 'none';
                return;
            }

            let matches = [];
            for (const id in window.inventoryData) {
                const medicineName = window.inventoryData[id].medicineName.toLowerCase();
                if(medicineName.startsWith(query)){
                    matches.push(window.inventoryData[id].medicineName);
                }
            }

            if(matches.length > 0){
                matches.forEach(name => {
                    const div = document.createElement('div');
                    div.classList.add('suggestion-item');
                    div.textContent = name;
                    div.onclick = () => {
                        inputElem.value = name;
                        suggestionsBox.innerHTML = '';
                        suggestionsBox.style.display = 'none';
                    };
                    suggestionsBox.appendChild(div);
                });
            } else {
                const div = document.createElement('div');
                div.classList.add('suggestion-item');
                div.textContent = `Add new product "${inputElem.value.trim()}"`;
                div.onclick = () => {
                    inputElem.value = inputElem.value.trim();
                    suggestionsBox.innerHTML = '';
                    suggestionsBox.style.display = 'none';
                    openAddProductModal(inputElem.value.trim());
                };
                suggestionsBox.appendChild(div);
            }

            suggestionsBox.style.display = 'block';
        }

        // Open Add Product Modal
        function openAddProductModal(medicineName = "") {
            document.getElementById('addProductModal').style.display = 'block';
            document.getElementById('newMedicineName').value = medicineName;
        }

        // Close Modal
        function closeModal() {
            document.getElementById('addProductModal').style.display = 'none';
            document.getElementById('addNewProductForm').reset();
        }

        // Add New Product from Modal
        const addNewProductForm = document.getElementById('addNewProductForm');
        addNewProductForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const medicineName = document.getElementById('newMedicineName').value.trim();
            const quantity = parseInt(document.getElementById('newQuantity').value);
            const tabletsPerStrip = parseInt(document.getElementById('newTabletsPerStrip').value);
            const batchNumber = document.getElementById('newBatchNumber').value.trim();
            const expiryDate = document.getElementById('newExpiryDate').value;
            const therapeuticClass = document.getElementById('newTherapeuticClass').value;

            const id = 'inv_' + new Date().getTime();

            window.inventoryData[id] = {
                medicineName,
                quantity,
                tabletsPerStrip,
                batchNumber,
                expiryDate,
                therapeuticClass
            };

            showNotification("New product added successfully!");
            populateInventoryTable();
            closeModal();
            saveDataToDrive();
        });

        /* ------------------- Google Drive Data Handling ---------------------------- */

        // Save all data to Drive
        async function saveAllData() {
            const data = {
                sales: window.salesData || {},
                inventory: window.inventoryData || {},
                customers: window.customersData || {},
                purchase: window.purchaseData || {}
            };

            try {
                const searchResponse = await searchFile('pharmacy_erp_data.json');
                if (searchResponse.result.files.length > 0) {
                    // File exists, update it
                    const fileId = searchResponse.result.files[0].id;
                    await updateFile(fileId, data);
                    showNotification("Data backed up to Google Drive successfully!");
                } else {
                    // File does not exist, create it
                    await createFile('pharmacy_erp_data.json', data);
                    showNotification("Data backed up to Google Drive successfully!");
                }
            } catch (error) {
                console.error("Error saving data to Drive:", error);
                showNotification("Error saving data to Drive.", true);
            }
        }

        // Load data from Drive on login
        async function loadDataFromDriveOnLogin() {
            try {
                const searchResponse = await searchFile('pharmacy_erp_data.json');
                if (searchResponse.result.files.length > 0) {
                    const fileId = searchResponse.result.files[0].id;
                    const contentResponse = await getFileContent(fileId);
                    const data = JSON.parse(contentResponse.body); // Ensure correct parsing

                    // Load Inventory Data
                    window.inventoryData = data.inventory || {};
                    populateInventoryTable();

                    // Load Sales Data
                    window.salesData = data.sales || {};
                    populateSalesTable();

                    // Load Customer Data
                    window.customersData = data.customers || {};
                    populateCustomerTable();

                    // Load Purchase Data
                    window.purchaseData = data.purchase || {};
                    populatePurchaseTable();

                    showNotification("Data loaded from Google Drive successfully!");
                } else {
                    showNotification("No backup file found on Drive.", true);
                }
            } catch (error) {
                console.error("Error loading data from Drive:", error);
                showNotification("Error loading data from Drive.", true);
            }
        }

        // Overriding saveDataToDrive to save all data
        function saveDataToDrive() {
            saveAllData();
        }

        // Load data from Drive after sign-in
        function loadDataFromDrive() {
            loadDataFromDriveOnLogin();
        }

        /* ------------------- Popup Modal Handling -------------------------- */

        // Close modal when clicking outside of the modal content
        window.onclick = function(event) {
            const modal = document.getElementById('addProductModal');
            if (event.target == modal) {
                closeModal();
            }
        }

    </script>

</body>
</html>
