<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy ERP System</title>
    <style>
        /* Basic Reset and Styling */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding-top: 20px;
            flex-shrink: 0;
            overflow-y: auto;
            display: none; /* Hidden by default, shown after login */
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .sidebar a {
            display: block;
            padding: 12px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: background 0.3s;
            cursor: pointer;
        }

        .sidebar a:hover {
            background-color: #34495e;
        }

        /* Main Content Styling */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #ecf0f1;
            display: none; /* Hidden by default, shown after login */
        }

        .module {
            display: none;
        }

        .module.active {
            display: block;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table, th, td {
            border: 1px solid #bdc3c7;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        /* Forms */
        form {
            margin-top: 15px;
            background-color: #fff;
            padding: 15px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
        }

        form input, form select, form button, form textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        form button {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        form button:hover {
            background-color: #34495e;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .sidebar a {float: left;}
            .main-content {margin-left: 0;}
        }

        @media (max-width: 600px) {
            .sidebar a {
                text-align: center;
                float: none;
            }
        }

        /* Notification Styling */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2ecc71;
            color: #fff;
            padding: 15px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            flex: 1;
            background-color: #ecf0f1;
        }

        .login-screen h1 {
            margin-bottom: 20px;
        }

        .login-button {
            padding: 10px 20px;
            background-color: #4285F4;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .login-button img {
            height: 20px;
            margin-right: 10px;
        }

        .login-button:hover {
            background-color: #357ae8;
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <h1>Welcome to Pharmacy ERP</h1>
        <button class="login-button" id="googleSignInButton">
            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google Logo">
            Sign in with Google
        </button>
    </div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <h2>Pharmacy ERP</h2>
        <a onclick="showModule('sales')">Sales and Billing (POS)</a>
        <a onclick="showModule('inventory')">Inventory Management</a>
        <a onclick="showModule('crm')">Customer Management (CRM)</a>
        <a onclick="showModule('purchase')">Purchase & Vendor Management</a>
        <a onclick="showModule('accounting')">Accounting & Finance</a>
        <a onclick="showModule('reporting')">Reporting & Analytics</a>
        <a onclick="showModule('compliance')">Regulatory Compliance</a>
        <a onclick="showModule('employee')">Employee Management</a>
        <a style="background-color:#c0392b; margin-top:20px;" onclick="signOut()">Sign Out</a>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">

        <!-- Notification -->
        <div id="notification" class="notification"></div>

        <!-- Sales and Billing Module (POS) -->
        <div id="sales" class="module active">
            <h2>Sales and Billing (POS)</h2>
            <button onclick="toggleVisibility('salesForm')">New Sale</button>
            <div id="salesForm" style="display:none;">
                <form id="addSalesForm">
                    <input type="text" id="saleMedicineName" placeholder="Medicine Name" required>
                    <input type="number" id="saleQuantity" placeholder="Quantity" min="1" required>
                    <input type="text" id="saleBarcode" placeholder="Barcode/QR Code">
                    <select id="paymentMethod" required>
                        <option value="">Select Payment Method</option>
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="UPI">UPI</option>
                        <option value="Digital Wallet">Digital Wallet</option>
                    </select>
                    <input type="text" id="salePrescription" placeholder="Prescription ID (if any)">
                    <textarea id="saleDiscount" placeholder="Discount Details"></textarea>
                    <button type="submit">Process Sale</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Sale ID</th>
                        <th>Medicine Name</th>
                        <th>Quantity</th>
                        <th>Total Price ($)</th>
                        <th>Tax ($)</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                    <!-- Sales records will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Inventory Management Module -->
        <div id="inventory" class="module">
            <h2>Inventory Management</h2>
            <button onclick="toggleVisibility('inventoryForm')">Add New Item</button>
            <div id="inventoryForm" style="display:none;">
                <form id="addInventoryForm">
                    <input type="text" id="medicineName" placeholder="Medicine Name" required>
                    <input type="number" id="quantity" placeholder="Quantity" min="1" required>
                    <input type="text" id="batchNumber" placeholder="Batch Number" required>
                    <input type="date" id="expiryDate" required>
                    <select id="therapeuticClass" required>
                        <option value="">Select Therapeutic Class</option>
                        <option value="Analgesics">Analgesics</option>
                        <option value="Antibiotics">Antibiotics</option>
                        <option value="Cardiovascular">Cardiovascular</option>
                        <!-- Add more classes as needed -->
                    </select>
                    <button type="submit">Add Inventory Item</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Medicine Name</th>
                        <th>Quantity</th>
                        <th>Batch Number</th>
                        <th>Expiry Date</th>
                        <th>Therapeutic Class</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <!-- Inventory items will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Customer Management (CRM) Module -->
        <div id="crm" class="module">
            <h2>Customer Management (CRM)</h2>
            <button onclick="toggleVisibility('crmForm')">Add Customer</button>
            <div id="crmForm" style="display:none;">
                <form id="addCustomerForm">
                    <input type="text" id="customerName" placeholder="Customer Name" required>
                    <input type="email" id="customerEmail" placeholder="Email" required>
                    <input type="text" id="customerPhone" placeholder="Phone Number" required>
                    <input type="text" id="customerPrescription" placeholder="Prescription History">
                    <button type="submit">Add Customer</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Customer ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Prescription History</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="crmTableBody">
                    <!-- Customer records will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Purchase & Vendor Management Module -->
        <div id="purchase" class="module">
            <h2>Purchase & Vendor Management</h2>
            <button onclick="toggleVisibility('purchaseForm')">New Purchase Order</button>
            <div id="purchaseForm" style="display:none;">
                <form id="addPurchaseForm">
                    <input type="text" id="vendorName" placeholder="Vendor Name" required>
                    <input type="text" id="purchaseMedicineName" placeholder="Medicine Name" required>
                    <input type="number" id="purchaseQuantity" placeholder="Quantity" min="1" required>
                    <select id="purchaseStatus" required>
                        <option value="">Select Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <button type="submit">Create Purchase Order</button>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>PO ID</th>
                        <th>Vendor</th>
                        <th>Medicine</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="purchaseTableBody">
                    <!-- Purchase orders will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Accounting & Finance Module -->
        <div id="accounting" class="module">
            <h2>Accounting & Finance</h2>
            <p>Integration with POS for daily sales tracking, automated GST/VAT filing, financial reports, and more.</p>
            <!-- Additional forms and tables can be added here -->
        </div>

        <!-- Reporting & Analytics Module -->
        <div id="reporting" class="module">
            <h2>Reporting & Analytics</h2>
            <p>Generate and view various reports on sales, inventory, profitability, and more.</p>
            <!-- Integration with Chart.js or similar libraries can be added for visual analytics -->
        </div>

        <!-- Regulatory Compliance Module -->
        <div id="compliance" class="module">
            <h2>Regulatory Compliance</h2>
            <p>Maintain records for controlled substances, integrate with e-prescription systems, and ensure legal compliance.</p>
            <!-- Additional forms and tables can be added here -->
        </div>

        <!-- Employee Management Module -->
        <div id="employee" class="module">
            <h2>Employee Management</h2>
            <p>Manage employee roles, track sales performance, handle shift schedules, and monitor attendance.</p>
            <!-- Additional forms and tables can be added here -->
        </div>

    </div>

    <!-- Firebase SDKs -->
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- Your JavaScript Code -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
 apiKey: "AIzaSyBJLp1AAqdEVxs-eZBUPPgNfK-SjOuLpz0",
  authDomain: "sms-verification-ea68f.firebaseapp.com",
  projectId: "sms-verification-ea68f",
  storageBucket: "sms-verification-ea68f.appspot.com",
  messagingSenderId: "977038537918",
  appId: "1:977038537918:web:46761c2376a03978851aef",
  measurementId: "G-ZE4HSES1R6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Google API Client ID
        const CLIENT_ID = '435268131943-eg8fv9chddsdkardf7t7rjqhpeqqrsa0.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA7esonB2-fACyK_vwx80uvBJ-HVyTukg0';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // Notification Function
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Initialize Google API Client
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(() => {
                console.log("Google API Client Initialized.");
            }, (error) => {
                console.error("Error initializing Google API client:", error);
                showNotification("Error initializing Google API client.", true);
            });
        }

        gapi.load('client:auth2', initClient);

        // Sign In with Google
        const googleSignInButton = document.getElementById('googleSignInButton');
        googleSignInButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/drive.file');
            firebase.auth().signInWithPopup(provider)
                .then((result) => {
                    // The signed-in user info.
                    const user = result.user;
                    // Get Google access token
                    const credential = result.credential;
                    const token = credential.accessToken;
                    // Initialize Google API Client with token
                    gapi.auth.setToken({
                        access_token: token
                    });
                    // Show ERP interface
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('sidebar').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'block';
                    showNotification("Successfully signed in!");
                }).catch((error) => {
                    console.error("Error during sign in:", error);
                    showNotification("Error during sign in.", true);
                });
        });

        // Sign Out Function
        function signOut() {
            firebase.auth().signOut().then(() => {
                // Sign-out successful.
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('sidebar').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';
                showNotification("Signed out successfully.");
            }).catch((error) => {
                console.error("Error during sign out:", error);
                showNotification("Error during sign out.", true);
            });
        }

        // Module Navigation
        function showModule(moduleId) {
            const modules = document.querySelectorAll('.module');
            modules.forEach(module => {
                if(module.id === moduleId){
                    module.classList.add('active');
                } else {
                    module.classList.remove('active');
                }
            });
        }

        // Toggle Form Visibility
        function toggleVisibility(formId) {
            const form = document.getElementById(formId);
            if (form.style.display === "none" || form.style.display === "") {
                form.style.display = "block";
            } else {
                form.style.display = "none";
            }
        }

        /* ------------------------- Sales and Billing (POS) ------------------------- */

        // Add Sale Record
        const addSalesForm = document.getElementById('addSalesForm');
        addSalesForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const medicineName = document.getElementById('saleMedicineName').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const barcode = document.getElementById('saleBarcode').value || "N/A";
            const paymentMethod = document.getElementById('paymentMethod').value;
            const prescription = document.getElementById('salePrescription').value || "N/A";
            const discountDetails = document.getElementById('saleDiscount').value || "0";
            const saleDate = new Date().toISOString().split('T')[0];
            const tax = calculateTax(medicineName, quantity);
            const totalPrice = calculatePrice(medicineName, quantity) + tax;

            db.collection('sales').add({
                medicineName,
                quantity,
                barcode,
                paymentMethod,
                prescription,
                discountDetails,
                saleDate,
                tax,
                totalPrice,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                addSalesForm.reset();
                document.getElementById('salesForm').style.display = 'none';
                showNotification("Sale processed successfully!");
                updateInventory(medicineName, quantity);
            })
            .catch(error => {
                console.error("Error adding sale: ", error);
                showNotification("Error processing sale.", true);
            });
        });

        // Calculate Price (Placeholder Logic)
        function calculatePrice(medicineName, quantity) {
            // Implement actual pricing logic based on medicine
            // For demonstration, assume $5 per unit
            return quantity * 5;
        }

        // Calculate Tax (Placeholder Logic)
        function calculateTax(medicineName, quantity) {
            // Implement actual tax calculation based on GST rules
            // For demonstration, assume 18% tax
            return (quantity * 5) * 0.18;
        }

        // Update Inventory After Sale
        function updateInventory(medicineName, quantitySold) {
            const inventoryRef = db.collection('inventory').where('medicineName', '==', medicineName);
            inventoryRef.get().then(querySnapshot => {
                if (!querySnapshot.empty) {
                    querySnapshot.forEach(doc => {
                        const currentQty = doc.data().quantity;
                        if (currentQty >= quantitySold) {
                            db.collection('inventory').doc(doc.id).update({
                                quantity: currentQty - quantitySold
                            })
                            .then(() => {
                                console.log("Inventory updated successfully.");
                            })
                            .catch(error => {
                                console.error("Error updating inventory: ", error);
                            });
                        } else {
                            showNotification(`Insufficient stock for ${medicineName}.`, true);
                        }
                    });
                } else {
                    showNotification(`Medicine ${medicineName} not found in inventory.`, true);
                }
            });
        }

        // Real-time Listener for Sales
        const salesTableBody = document.getElementById('salesTableBody');
        db.collection('sales').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
            salesTableBody.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${doc.id}</td>
                    <td>${data.medicineName}</td>
                    <td>${data.quantity}</td>
                    <td>${data.totalPrice.toFixed(2)}</td>
                    <td>${data.tax.toFixed(2)}</td>
                    <td>${data.saleDate}</td>
                    <td>
                        <button onclick="viewSale('${doc.id}')">View</button>
                        <!-- Implement Edit/Delete if needed -->
                    </td>
                `;
                salesTableBody.appendChild(row);
            });
        });

        // View Sale Details
        function viewSale(id) {
            db.collection('sales').doc(id).get()
            .then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    alert(`Sale Details:
Sale ID: ${doc.id}
Medicine Name: ${data.medicineName}
Quantity: ${data.quantity}
Tax: $${data.tax.toFixed(2)}
Total Price: $${data.totalPrice.toFixed(2)}
Payment Method: ${data.paymentMethod}
Prescription: ${data.prescription}
Date: ${data.saleDate}`);
                } else {
                    alert("No such sale record!");
                }
            })
            .catch(error => {
                console.error("Error fetching sale: ", error);
            });
        }

        /* ------------------------- Inventory Management ---------------------------- */

        // Add Inventory Item
        const addInventoryForm = document.getElementById('addInventoryForm');
        addInventoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const medicineName = document.getElementById('medicineName').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const batchNumber = document.getElementById('batchNumber').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const therapeuticClass = document.getElementById('therapeuticClass').value;

            db.collection('inventory').add({
                medicineName,
                quantity,
                batchNumber,
                expiryDate,
                therapeuticClass,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                addInventoryForm.reset();
                document.getElementById('inventoryForm').style.display = 'none';
                showNotification("Inventory item added successfully!");
            })
            .catch(error => {
                console.error("Error adding inventory: ", error);
                showNotification("Error adding inventory item.", true);
            });
        });

        // Real-time Listener for Inventory
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        db.collection('inventory').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
            inventoryTableBody.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${data.medicineName}</td>
                    <td>${data.quantity}</td>
                    <td>${data.batchNumber}</td>
                    <td>${data.expiryDate}</td>
                    <td>${data.therapeuticClass}</td>
                    <td>
                        <button onclick="editInventory('${doc.id}', '${data.medicineName}', ${data.quantity}, '${data.batchNumber}', '${data.expiryDate}', '${data.therapeuticClass}')">Edit</button>
                        <button onclick="deleteInventory('${doc.id}')">Delete</button>
                    </td>
                `;
                inventoryTableBody.appendChild(row);
            });
        });

        // Edit Inventory Item
        function editInventory(id, medicineName, quantity, batchNumber, expiryDate, therapeuticClass) {
            const newMedicineName = prompt("Enter new Medicine Name:", medicineName);
            if (newMedicineName === null) return; // Cancelled
            const newQuantity = prompt("Enter new Quantity:", quantity);
            if (newQuantity === null || isNaN(newQuantity) || newQuantity < 0) {
                showNotification("Invalid quantity entered.", true);
                return;
            }
            const newBatchNumber = prompt("Enter new Batch Number:", batchNumber);
            if (newBatchNumber === null) return;
            const newExpiryDate = prompt("Enter new Expiry Date (YYYY-MM-DD):", expiryDate);
            if (newExpiryDate === null) return;
            const newTherapeuticClass = prompt("Enter new Therapeutic Class:", therapeuticClass);
            if (newTherapeuticClass === null) return;

            db.collection('inventory').doc(id).update({
                medicineName: newMedicineName,
                quantity: parseInt(newQuantity),
                batchNumber: newBatchNumber,
                expiryDate: newExpiryDate,
                therapeuticClass: newTherapeuticClass
            })
            .then(() => {
                showNotification("Inventory updated successfully!");
            })
            .catch(error => {
                console.error("Error updating inventory: ", error);
                showNotification("Error updating inventory.", true);
            });
        }

        // Delete Inventory Item
        function deleteInventory(id) {
            if(confirm("Are you sure you want to delete this inventory item?")) {
                db.collection('inventory').doc(id).delete()
                .then(() => {
                    showNotification("Inventory item deleted successfully!");
                })
                .catch(error => {
                    console.error("Error deleting inventory item: ", error);
                    showNotification("Error deleting inventory item.", true);
                });
            }
        }

        /* ------------------------- Customer Management (CRM) ---------------------- */

        // Add Customer
        const addCustomerForm = document.getElementById('addCustomerForm');
        addCustomerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const customerName = document.getElementById('customerName').value;
            const customerEmail = document.getElementById('customerEmail').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const prescriptionHistory = document.getElementById('customerPrescription').value || "N/A";

            db.collection('customers').add({
                customerName,
                customerEmail,
                customerPhone,
                prescriptionHistory,
                loyaltyPoints: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                addCustomerForm.reset();
                document.getElementById('crmForm').style.display = 'none';
                showNotification("Customer added successfully!");
            })
            .catch(error => {
                console.error("Error adding customer: ", error);
                showNotification("Error adding customer.", true);
            });
        });

        // Real-time Listener for Customers
        const crmTableBody = document.getElementById('crmTableBody');
        db.collection('customers').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
            crmTableBody.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${doc.id}</td>
                    <td>${data.customerName}</td>
                    <td>${data.customerEmail}</td>
                    <td>${data.customerPhone}</td>
                    <td>${data.prescriptionHistory}</td>
                    <td>
                        <button onclick="viewCustomer('${doc.id}')">View</button>
                        <button onclick="updateLoyalty('${doc.id}', ${data.loyaltyPoints})">Update Loyalty</button>
                        <button onclick="deleteCustomer('${doc.id}')">Delete</button>
                    </td>
                `;
                crmTableBody.appendChild(row);
            });
        });

        // View Customer Details
        function viewCustomer(id) {
            db.collection('customers').doc(id).get()
            .then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    alert(`Customer Details:
ID: ${doc.id}
Name: ${data.customerName}
Email: ${data.customerEmail}
Phone: ${data.customerPhone}
Prescription History: ${data.prescriptionHistory}
Loyalty Points: ${data.loyaltyPoints}`);
                } else {
                    alert("No such customer record!");
                }
            })
            .catch(error => {
                console.error("Error fetching customer: ", error);
            });
        }

        // Update Loyalty Points
        function updateLoyalty(id, currentPoints) {
            const additionalPoints = prompt("Enter additional loyalty points:", 0);
            if (additionalPoints === null || isNaN(additionalPoints) || additionalPoints < 0) {
                showNotification("Invalid points entered.", true);
                return;
            }
            db.collection('customers').doc(id).update({
                loyaltyPoints: currentPoints + parseInt(additionalPoints)
            })
            .then(() => {
                showNotification("Loyalty points updated successfully!");
            })
            .catch(error => {
                console.error("Error updating loyalty points: ", error);
                showNotification("Error updating loyalty points.", true);
            });
        }

        // Delete Customer
        function deleteCustomer(id) {
            if(confirm("Are you sure you want to delete this customer?")) {
                db.collection('customers').doc(id).delete()
                .then(() => {
                    showNotification("Customer deleted successfully!");
                })
                .catch(error => {
                    console.error("Error deleting customer: ", error);
                    showNotification("Error deleting customer.", true);
                });
            }
        }

        /* ---------------------- Purchase & Vendor Management ----------------------- */

        // Add Purchase Order
        const addPurchaseForm = document.getElementById('addPurchaseForm');
        addPurchaseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const vendorName = document.getElementById('vendorName').value;
            const purchaseMedicineName = document.getElementById('purchaseMedicineName').value;
            const purchaseQuantity = parseInt(document.getElementById('purchaseQuantity').value);
            const purchaseStatus = document.getElementById('purchaseStatus').value;
            const purchaseDate = new Date().toISOString().split('T')[0];

            db.collection('purchase').add({
                vendorName,
                purchaseMedicineName,
                purchaseQuantity,
                purchaseStatus,
                purchaseDate,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                addPurchaseForm.reset();
                document.getElementById('purchaseForm').style.display = 'none';
                showNotification("Purchase order created successfully!");
            })
            .catch(error => {
                console.error("Error adding purchase order: ", error);
                showNotification("Error creating purchase order.", true);
            });
        });

        // Real-time Listener for Purchase Orders
        const purchaseTableBody = document.getElementById('purchaseTableBody');
        db.collection('purchase').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
            purchaseTableBody.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${doc.id}</td>
                    <td>${data.vendorName}</td>
                    <td>${data.purchaseMedicineName}</td>
                    <td>${data.purchaseQuantity}</td>
                    <td>${data.purchaseStatus}</td>
                    <td>${data.purchaseDate}</td>
                    <td>
                        <button onclick="updatePurchaseStatus('${doc.id}', '${data.purchaseStatus}')">Update</button>
                        <button onclick="deletePurchase('${doc.id}')">Delete</button>
                    </td>
                `;
                purchaseTableBody.appendChild(row);
            });
        });

        // Update Purchase Status
        function updatePurchaseStatus(id, currentStatus) {
            const newStatus = prompt("Enter new status (Pending, Completed, Cancelled):", currentStatus);
            if (newStatus === null || !["Pending", "Completed", "Cancelled"].includes(newStatus)) {
                showNotification("Invalid status entered.", true);
                return;
            }
            db.collection('purchase').doc(id).update({
                purchaseStatus: newStatus
            })
            .then(() => {
                showNotification("Purchase status updated successfully!");
                if(newStatus === "Completed") {
                    // Optionally, add to inventory
                    // Implement logic to auto-add purchased quantity to inventory
                }
            })
            .catch(error => {
                console.error("Error updating purchase status: ", error);
                showNotification("Error updating purchase status.", true);
            });
        }

        // Delete Purchase Order
        function deletePurchase(id) {
            if(confirm("Are you sure you want to delete this purchase order?")) {
                db.collection('purchase').doc(id).delete()
                .then(() => {
                    showNotification("Purchase order deleted successfully!");
                })
                .catch(error => {
                    console.error("Error deleting purchase order: ", error);
                    showNotification("Error deleting purchase order.", true);
                });
            }
        }

        /* ---------------------- Accounting & Finance Module ------------------------ */

        // Placeholder for Accounting & Finance functionalities
        // Implement integration with sales data, GST/VAT calculations, financial reports, etc.

        /* ---------------------- Reporting & Analytics Module ------------------------ */

        // Placeholder for Reporting & Analytics functionalities
        // Integrate libraries like Chart.js for visual reports
        // Fetch data from Firestore and display summaries and charts

        /* ---------------------- Regulatory Compliance Module ------------------------ */

        // Placeholder for Regulatory Compliance functionalities
        // Implement controlled substance tracking, e-prescription integration, etc.

        /* ---------------------- Employee Management Module -------------------------- */

        // Placeholder for Employee Management functionalities
        // Implement role-based access, performance tracking, shift schedules, etc.

        /* ------------------- Google Drive Integration ------------------------------ */

        // Save Data to Google Drive
        function saveDataToDrive() {
            const data = {
                sales: {},
                inventory: {},
                customers: {},
                purchase: {}
            };

            // Fetch data from Firestore
            db.collection('sales').get().then(snapshot => {
                snapshot.forEach(doc => {
                    data.sales[doc.id] = doc.data();
                });
                return db.collection('inventory').get();
            }).then(snapshot => {
                snapshot.forEach(doc => {
                    data.inventory[doc.id] = doc.data();
                });
                return db.collection('customers').get();
            }).then(snapshot => {
                snapshot.forEach(doc => {
                    data.customers[doc.id] = doc.data();
                });
                return db.collection('purchase').get();
            }).then(snapshot => {
                snapshot.forEach(doc => {
                    data.purchase[doc.id] = doc.data();
                });
                // Convert data to JSON string
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const metadata = {
                    'name': 'pharmacy_erp_data.json',
                    'mimeType': 'application/json'
                };

                // Create file on Drive
                const accessToken = gapi.auth.getToken().access_token;
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form,
                }).then((res) => {
                    return res.json();
                }).then(function(val) {
                    showNotification("Data saved to Google Drive successfully!");
                    console.log("File ID: ", val.id);
                }).catch(error => {
                    console.error("Error uploading to Drive:", error);
                    showNotification("Error saving data to Drive.", true);
                });
            }).catch(error => {
                console.error("Error fetching data for Drive upload:", error);
                showNotification("Error preparing data for Drive upload.", true);
            });
        }

        // Load Data from Google Drive
        function loadDataFromDrive() {
            const accessToken = gapi.auth.getToken().access_token;
            // Search for the file by name
            fetch('https://www.googleapis.com/drive/v3/files?q=name="pharmacy_erp_data.json"', {
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
            })
            .then(response => response.json())
            .then(data => {
                if(data.files.length > 0){
                    const fileId = data.files[0].id;
                    // Download the file content
                    fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                        headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    })
                    .then(response => response.json())
                    .then(jsonData => {
                        // Parse and load data into Firestore
                        // Clear existing data (optional)
                        clearFirestoreData().then(() => {
                            // Add sales data
                            for (const saleId in jsonData.sales) {
                                db.collection('sales').doc(saleId).set(jsonData.sales[saleId]);
                            }
                            // Add inventory data
                            for (const inventoryId in jsonData.inventory) {
                                db.collection('inventory').doc(inventoryId).set(jsonData.inventory[inventoryId]);
                            }
                            // Add customer data
                            for (const customerId in jsonData.customers) {
                                db.collection('customers').doc(customerId).set(jsonData.customers[customerId]);
                            }
                            // Add purchase data
                            for (const purchaseId in jsonData.purchase) {
                                db.collection('purchase').doc(purchaseId).set(jsonData.purchase[purchaseId]);
                            }
                            showNotification("Data loaded from Google Drive successfully!");
                        });
                    })
                    .catch(error => {
                        console.error("Error downloading file from Drive:", error);
                        showNotification("Error loading data from Drive.", true);
                    });
                } else {
                    showNotification("No backup file found on Drive.", true);
                }
            })
            .catch(error => {
                console.error("Error searching for file on Drive:", error);
                showNotification("Error searching for backup file on Drive.", true);
            });
        }

        // Clear Firestore Data (Use with caution)
        async function clearFirestoreData() {
            const collections = ['sales', 'inventory', 'customers', 'purchase'];
            for (const collection of collections) {
                const querySnapshot = await db.collection(collection).get();
                querySnapshot.forEach(doc => {
                    db.collection(collection).doc(doc.id).delete().catch(error => {
                        console.error(`Error deleting document ${doc.id} from ${collection}:`, error);
                    });
                });
            }
        }

        /* ----------------------- Google Drive Buttons ----------------------------- */

        // Add buttons to save and load data from Drive
        // You can place these buttons in an appropriate module, e.g., Accounting & Finance or Reporting

        // For demonstration, we'll add them to the Accounting & Finance module
        const accountingModule = document.getElementById('accounting');
        const driveButtonsHTML = `
            <button onclick="saveDataToDrive()">Backup Data to Google Drive</button>
            <button onclick="loadDataFromDrive()">Restore Data from Google Drive</button>
        `;
        accountingModule.insertAdjacentHTML('beforeend', driveButtonsHTML);

    </script>

</body>
</html>
